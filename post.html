<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Blog — TIDEA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/favicon.png" />
  <style>
    :root {
      --bg: #FAF9F7;
      --text: #2B2B2B;
      --muted: #6B6B6B;
      --card: #FFFFFF;
      --border: #E9E4DF;
      --accent: #B85C38;
      --accent-hover: #9b4a2d;
    }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text); line-height: 1.6; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 28px 20px 80px; }
    header { text-align: center; padding: 40px 0 20px; }
    h1 { font-size: 2.2rem; margin-bottom: 6px; }
    main { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; }
    h2 { font-size: 1.4rem; margin-top: 28px; }
    a { color: var(--accent); text-decoration: underline; }
    .btnRow { margin: 16px 0 24px; display: flex; justify-content: center; }
    .btn { background: var(--accent); color: #fff; border: none; border-radius: 10px; padding: 10px 14px; font-weight: 700; cursor: pointer; display: inline-block; text-decoration: none; }
    .btn:hover { background: var(--accent-hover); }
    footer { text-align: center; margin-top: 28px; color: var(--muted); font-size: 0.9rem; }
    .meta { color: var(--muted); font-size: 0.95rem; margin: 10px 0 18px; }
    .cover { width: 100%; max-height: 420px; object-fit: cover; border-radius: 8px; margin: 6px 0 18px; border: 1px solid var(--border); }
    /* Markdown defaults */
    main img { max-width: 100%; border-radius: 8px; }
    main pre { background: #f4f0eb; padding: 12px; border-radius: 8px; overflow-x: auto; }
    main code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    main blockquote { margin: 0; padding-left: 14px; border-left: 4px solid var(--border); color: var(--muted); }
    .hidden { display: none; }
  </style>
  <!-- Tiny Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="post-title">Loading…</h1>
      <div class="btnRow">
        <a class="btn" href="/index.html">← Back to Home</a>
      </div>
    </header>

    <main>
      <img id="post-cover" class="cover hidden" alt="" />
      <div id="post-meta" class="meta"></div>
      <div id="post-content">Please wait…</div>
    </main>

    <footer>
      <p>© <span id="year"></span> TIDEA • <a href="/privacy.html">Privacy Policy</a></p>
    </footer>
  </div>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // Read slug from ?slug=...
    const params = new URLSearchParams(location.search);
    const SLUG = params.get('slug');

    // Supabase (same keys you use on your index page)
    const SUPABASE_URL = 'https://hciergtglghsfezgkkni.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjaWVyZ3RnbGdoc2Zlemdra25pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NDMzOTQsImV4cCI6MjA3MjQxOTM5NH0.xyC-7gDbRh0OfZRxtTNOfVEHw0Kh0JBfDCqYcIC1POs';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Helpers
    function isPublished(v) {
      if (v === true) return true;
      if (typeof v === 'string') {
        const s = v.trim().toLowerCase();
        return s === 'true' || s === 't' || s === '1' || s === 'yes';
      }
      if (typeof v === 'number') return v === 1;
      return false;
    }
    function fmtDate(s) {
      try { return new Date(s).toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' }); }
      catch { return ''; }
    }

    async function loadPost() {
      const titleEl = document.getElementById('post-title');
      const metaEl  = document.getElementById('post-meta');
      const coverEl = document.getElementById('post-cover');
      const contentEl = document.getElementById('post-content');

      if (!SLUG) {
        titleEl.textContent = 'Post not found';
        contentEl.textContent = 'Missing slug parameter.';
        return;
      }

      const { data, error } = await _supabase
        .from('blog_posts')
        .select('slug,title,author,excerpt,cover_image_url,content_md,published,published_at,created_at')
        .eq('slug', SLUG)
        .limit(1)
        .maybeSingle();

      if (error || !data || !isPublished(data.published)) {
        titleEl.textContent = 'Post not found';
        contentEl.textContent = 'This post may be unpublished or the link is incorrect.';
        return;
      }

      titleEl.textContent = data.title || 'Untitled';
      const when = data.published_at || data.created_at;
      const parts = [
        data.author ? `By ${data.author}` : null,
        when ? fmtDate(when) : null
      ].filter(Boolean);
      metaEl.textContent = parts.join(' • ');

      if (data.cover_image_url) {
        coverEl.src = data.cover_image_url;
        coverEl.alt = data.title || 'Cover image';
        coverEl.classList.remove('hidden');
      }

      // Render markdown safely into HTML
      const md = data.content_md || '';
      contentEl.innerHTML = marked.parse(md);
    }

    loadPost();
  </script>
</body>
</html>
